<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฅุฏุฎุงู ูุทุงูุจุงุช ุงูุชุฃููู ุงูุตุญู - Google Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container-main {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-6">
    <div class="container-main max-w-7xl mx-auto p-8 rounded-xl shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">ูุธุงู ุฅุฏุฎุงู ูุทุงูุจุงุช ุงูุชุฃููู ุงูุตุญู</h1>
            <p class="text-gray-600">ุงูุชุฎุฒูู ุนุจุฑ Google Sheets ูุงููุฑููุงุช ุนุจุฑ Google Drive</p>
            <div id="auth-status" class="mt-4">
                <button id="authorize-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300">
                    ุชุณุฌูู ุงูุฏุฎูู ุจุญุณุงุจ Google
                </button>
                <button id="signout-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">
                    ุชุณุฌูู ุงูุฎุฑูุฌ
                </button>
            </div>
            <div id="user-info" class="hidden mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 rounded-lg text-center mb-4" role="alert"></div>

        <!-- Main Content (Hidden until authenticated) -->
        <div id="main-content" class="hidden">
            <!-- Data Entry Form -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">ุฅุฏุฎุงู ูุทุงูุจุฉ ุฌุฏูุฏุฉ</h2>
                <form id="record-form" class="space-y-4">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงูููุงููุฉ</label>
                            <input type="text" name="approvalNumber" class="w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงููููุฐุฌ</label>
                            <input type="text" name="formNumber" class="w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุฑูุถ *</label>
                            <input type="text" name="patientName" required class="w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                    </div>

                    <!-- Doctor Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ ุจูุงูุงุช ุงูุทุจูุจ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูุทุจูุจ *</label>
                                <input type="text" name="doctorName" required class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุชุฎุตุต *</label>
                                <input type="text" name="specialization" required class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</label>
                                <input type="date" name="treatmentDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฑููุงุช</label>
                                <input type="file" name="doctorFile" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                            </div>
                        </div>
                    </div>

                    <!-- Hospital Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ฅ ุจูุงูุงุช ุงููุณุชุดูู</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุณุชุดูู</label>
                                <input type="text" name="hospital" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</label>
                                <input type="date" name="hospitalTreatmentDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฑููุงุช</label>
                                <input type="file" name="hospitalFile" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                            </div>
                        </div>
                    </div>

                    <!-- Laboratory Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ฌ ุจูุงูุงุช ุงููุฎุชุจุฑ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฎุชุจุฑ</label>
                                <input type="text" name="laboratory" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</label>
                                <input type="date" name="labTreatmentDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฑููุงุช</label>
                                <input type="file" name="laboratoryFile" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                            </div>
                        </div>
                    </div>

                    <!-- Pharmacy Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ ุจูุงูุงุช ุงูุตูุฏููุฉ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุตูุฏููุฉ</label>
                                <input type="text" name="pharmacy" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</label>
                                <input type="date" name="pharmacyTreatmentDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฑููุงุช</label>
                                <input type="file" name="pharmacyFile" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                            </div>
                        </div>
                    </div>

                    <!-- Radiology Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ก ุจูุงูุงุช ุงูุฃุดุนุฉ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ูุฑูุฒ ุงูุฃุดุนุฉ</label>
                                <input type="text" name="radiology" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</label>
                                <input type="date" name="radiologyTreatmentDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุฑููุงุช</label>
                                <input type="file" name="radiologyFile" accept="image/*,application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">๐ ุจูุงูุงุช ุฅุถุงููุฉ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุฑุณูู ุงููููุฐุฌ</label>
                                <input type="number" name="formFee" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงููููุฐุฌ</label>
                                <input type="date" name="formDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ุชุงุฑูุฎ ุงูุชุฃุซูุฑ ุนูู ุงูุฑุตูุฏ</label>
                                <input type="date" name="balanceDate" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button type="submit" id="save-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="save-button-text">ุญูุธ ุงูุณุฌู</span>
                        </button>
                        <button type="button" id="clear-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300">
                            ูุณุญ ุงููููุฐุฌ
                        </button>
                    </div>
                </form>
            </div>

            <!-- Search and Filter Section -->
            <div class="bg-white p-4 rounded-xl shadow mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุญุซ ุญุณุจ:</label>
                        <select id="filter-column" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="2">ุงุณู ุงููุฑูุถ</option>
                            <option value="0">ุฑูู ุงูููุงููุฉ</option>
                            <option value="1">ุฑูู ุงููููุฐุฌ</option>
                            <option value="3">ุงุณู ุงูุทุจูุจ</option>
                            <option value="4">ุงูุชุฎุตุต</option>
                            <option value="6">ุงููุณุชุดูู</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงูุจุญุซ:</label>
                        <input type="text" id="search-input" placeholder="ุงูุชุจ ููุจุญุซ..." class="w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="refresh-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">
                            ุชุญุฏูุซ
                        </button>
                        <button id="export-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">
                            ุชุตุฏูุฑ Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Records Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <h2 class="text-2xl font-bold text-gray-700 p-4 border-b">ุงูุณุฌูุงุช ุงููุญููุธุฉ</h2>
                <div id="loading-indicator" class="hidden flex justify-center items-center p-8">
                    <div class="loading-spinner"></div>
                    <span class="mr-3 text-gray-600">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-gray-700">
                            <tr>
                                <th class="p-3 text-center">ุฑูู ุงูููุงููุฉ</th>
                                <th class="p-3 text-center">ุฑูู ุงููููุฐุฌ</th>
                                <th class="p-3 text-center">ุงุณู ุงููุฑูุถ</th>
                                <th class="p-3 text-center">ุงุณู ุงูุทุจูุจ</th>
                                <th class="p-3 text-center">ุงูุชุฎุตุต</th>
                                <th class="p-3 text-center">ุชุงุฑูุฎ ุงููุนุงูุฌุฉ</th>
                                <th class="p-3 text-center">ุงููุณุชุดูู</th>
                                <th class="p-3 text-center">ุงููุฑููุงุช</th>
                                <th class="p-3 text-center">ุชุงุฑูุฎ ุงูุฅุฏุฎุงู</th>
                                <th class="p-3 text-center">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="divide-y divide-gray-200">
                            <!-- Records will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <h3 class="text-lg font-bold text-gray-900 mb-4">ุชุฃููุฏ ุงูุญุฐู</h3>
            <p class="text-sm text-gray-500 mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุนูููุฉ.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400">ุฅูุบุงุก</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700">ุญุฐู</button>
            </div>
        </div>
    </div>

    <script>
        // ุฅุนุฏุงุฏุงุช Google API
        const CLIENT_ID = '696330237242-oei5b5k6njmfjva5tkj8ifcrvjvjo6k7.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyC8mQ9v1MfAqPXzqeV850ETHrrFqiaExqs';
        const SPREADSHEET_ID = '1gokXoCPd9XtH7eq92MGJF-d5hEmDgjGEJV5Gk4_9hJk';
        const DRIVE_FOLDER_ID = '1FMl04vxqLZ02DyB8cy4YItDw_vV9tY_7';
        const DISCOVERY_DOCS = [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

        let authorizeButton = document.getElementById('authorize-button');
        let signoutButton = document.getElementById('signout-button');
        let mainContent = document.getElementById('main-content');
        let userInfo = document.getElementById('user-info');
        let editingRow = null;
        let allRecords = [];

        // Google API Client Initialization
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function() {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }, function(error) {
                console.error('Error initializing Google API client:', error);
                showMessage('ุฎุทุฃ ูู ุชููุฆุฉ Google API. ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช.', 'error');
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                userInfo.innerHTML = `ูุฑุญุจุงูุ ${profile.getName()} (${profile.getEmail()})`;
                userInfo.classList.remove('hidden');
                checkAndCreateSpreadsheet();
                loadRecords();
            } else {
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                mainContent.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
        }

        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        // Check/Initialize Spreadsheet
        async function checkAndCreateSpreadsheet() {
            try {
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID
                });
                const range = 'Sheet1!A1:T1';
                const valuesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range
                });
                if (!valuesResponse.result.values || valuesResponse.result.values[0].length === 0) {
                    const headers = [
                        'ุฑูู ุงูููุงููุฉ', 'ุฑูู ุงููููุฐุฌ', 'ุงุณู ุงููุฑูุถ', 'ุงุณู ุงูุทุจูุจ', 'ุงูุชุฎุตุต',
                        'ุชุงุฑูุฎ ุงููุนุงูุฌุฉ', 'ุงููุณุชุดูู', 'ุชุงุฑูุฎ ูุนุงูุฌุฉ ุงููุณุชุดูู', 'ุงููุฎุชุจุฑ', 'ุชุงุฑูุฎ ูุนุงูุฌุฉ ุงููุฎุชุจุฑ',
                        'ุงูุตูุฏููุฉ', 'ุชุงุฑูุฎ ูุนุงูุฌุฉ ุงูุตูุฏููุฉ', 'ุงูุฃุดุนุฉ', 'ุชุงุฑูุฎ ูุนุงูุฌุฉ ุงูุฃุดุนุฉ',
                        'ุฑุณูู ุงููููุฐุฌ', 'ุชุงุฑูุฎ ุงููููุฐุฌ', 'ุชุงุฑูุฎ ุงูุชุฃุซูุฑ ุนูู ุงูุฑุตูุฏ', 'ุชุงุฑูุฎ ุงูุฅุฏุฎุงู',
                        'ุฑูุงุจุท ุงููุฑููุงุช', 'ูุนุฑู ุงูุณุฌู'
                    ];
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Sheet1!A1:T1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [headers]
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking spreadsheet:', error);
                showMessage('ุชุญุฐูุฑ: ุชุญูู ูู ุตุญุฉ ูุนุฑู ุฌุฏูู ุงูุจูุงูุงุช', 'error');
            }
        }

        // Load Records
        async function loadRecords() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A2:T'
                });
                allRecords = response.result.values || [];
                filterAndDisplayRecords();
            } catch (error) {
                console.error('Error loading records:', error);
                showMessage('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function filterAndDisplayRecords() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const filterColumn = parseInt(document.getElementById('filter-column').value);
            let filteredRecords = allRecords;
            if (searchInput) {
                filteredRecords = allRecords.filter(record => {
                    const value = record[filterColumn] || '';
                    return value.toLowerCase().includes(searchInput);
                });
            }
            displayRecords(filteredRecords);
        }

        function displayRecords(records) {
            const tbody = document.getElementById('records-table-body');
            tbody.innerHTML = '';
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุณุฌูุงุช</td></tr>';
                return;
            }
            records.forEach((record, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const hasAttachments = record[18] && record[18].trim() !== '';
                const attachmentLinks = hasAttachments ? record[18].split(',') : [];
                row.innerHTML = `
                    <td class="p-3 text-center">${record[0] || ''}</td>
                    <td class="p-3 text-center">${record[1] || ''}</td>
                    <td class="p-3 text-center">${record[2] || ''}</td>
                    <td class="p-3 text-center">${record[3] || ''}</td>
                    <td class="p-3 text-center">${record[4] || ''}</td>
                    <td class="p-3 text-center">${record[5] || ''}</td>
                    <td class="p-3 text-center">${record[6] || ''}</td>
                    <td class="p-3 text-center">
                        ${hasAttachments ? 
                            `<a href="${attachmentLinks[0]}" target="_blank" class="text-blue-600 hover:underline">ุนุฑุถ</a>` : 
                            '<span class="text-gray-400">-</span>'}
                    </td>
                    <td class="p-3 text-center">${record[17] || ''}</td>
                    <td class="p-3 text-center whitespace-nowrap">
                        <button onclick="editRecord(${allRecords.indexOf(record) + 2})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full text-xs ml-1">ุชุนุฏูู</button>
                        <button onclick="deleteRecord(${allRecords.indexOf(record) + 2})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-xs">ุญุฐู</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ุญูุธ ุงูุณุฌู ูุงููุฑููุงุช
        document.getElementById('record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = document.getElementById('save-button');
            const saveButtonText = document.getElementById('save-button-text');
            saveButton.disabled = true;
            saveButtonText.textContent = 'ุฌุงุฑู ุงูุญูุธ...';

            const formData = new FormData(e.target);
            const recordData = [];
            const fields = [
                'approvalNumber', 'formNumber', 'patientName', 'doctorName', 'specialization',
                'treatmentDate', 'hospital', 'hospitalTreatmentDate', 'laboratory', 'labTreatmentDate',
                'pharmacy', 'pharmacyTreatmentDate', 'radiology', 'radiologyTreatmentDate',
                'formFee', 'formDate', 'balanceDate'
            ];

            // ุฌูุน ุงูุจูุงูุงุช ุงููุตูุฉ
            fields.forEach(field => {
                recordData.push(formData.get(field) || '');
            });

            // ุฑูุน ุงููููุงุช ูุฌูุน ุงูุฑูุงุจุท
            const fileFields = [
                'doctorFile', 'hospitalFile', 'laboratoryFile', 'pharmacyFile', 'radiologyFile'
            ];
            let attachmentLinks = [];
            for (let fileField of fileFields) {
                const file = formData.get(fileField);
                if (file && file.size > 0) {
                    try {
                        const fileMetadata = {
                            'name': file.name,
                            'parents': [DRIVE_FOLDER_ID]
                        };
                        const media = {
                            mimeType: file.type,
                            body: file
                        };
                        const uploadResponse = await gapi.client.drive.files.create({
                            resource: fileMetadata,
                            media: media,
                            fields: 'id,webViewLink'
                        });
                        const fileId = uploadResponse.result.id;
                        const webViewLink = uploadResponse.result.webViewLink || `https://drive.google.com/file/d/${fileId}/view`;
                        attachmentLinks.push(webViewLink);
                        await gapi.client.drive.permissions.create({
                            fileId: fileId,
                            resource: {
                                role: 'reader',
                                type: 'anyone'
                            }
                        });
                    } catch (err) {
                        attachmentLinks.push('');
                        console.error('File upload error:', err);
                    }
                } else {
                    attachmentLinks.push('');
                }
            }
            recordData.push(attachmentLinks.join(','));
            recordData.push(new Date().toLocaleString('en-GB'));
            recordData.push(Date.now().toString());

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A2:T',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [recordData]
                    }
                });
                showMessage('ุชู ุญูุธ ุงูุณุฌู ุจูุฌุงุญ', 'success');
                e.target.reset();
                loadRecords();
            } catch (error) {
                console.error('Error saving record:', error);
                showMessage('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุณุฌู', 'error');
            }
            saveButton.disabled = false;
            saveButtonText.textContent = 'ุญูุธ ุงูุณุฌู';
        });

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-4 rounded-lg text-center mb-4 ${type === 'error' ? 'bg-red-100 text-red-700' : type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3500);
        }

        window.onload = handleClientLoad;
        document.getElementById('search-input').addEventListener('input', filterAndDisplayRecords);
        document.getElementById('filter-column').addEventListener('change', filterAndDisplayRecords);
        document.getElementById('refresh-button').addEventListener('click', loadRecords);

        document.getElementById('clear-button').addEventListener('click', function() {
            document.getElementById('record-form').reset();
        });
    </script>
</body>
</html>
