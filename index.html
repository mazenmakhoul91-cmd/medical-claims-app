<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدخال مطالبات التأمين الصحي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level for debugging
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, recordsCollection;
        let userId = null;
        
        // Global state for records, editing, and local attachments
        let editingId = null;
        let records = [];
        let localAttachments = {}; // Stores file data temporarily in the browser

        // Get DOM elements
        const form = document.getElementById('record-form');
        const saveButton = document.getElementById('save-button');
        const clearButton = document.getElementById('clear-button');
        const recordsTableBody = document.getElementById('records-table-body');
        const messageBox = document.getElementById('message-box');
        const loadingIndicator = document.getElementById('loading-indicator');
        const filterColumnSelect = document.getElementById('filter-column-select');
        const filterInput = document.getElementById('filter-input');
        const exportButton = document.getElementById('export-button');
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');
        const userIdDisplay = document.getElementById('user-id-display');
        const statusText = document.getElementById('status-text');
        const statusIcon = document.getElementById('status-icon');

        function updateStatus(isOnline) {
            if (isOnline) {
                statusIcon.className = 'rounded-full h-24 w-24 mx-auto flex items-center justify-center mb-4 transition-all duration-500 bg-green-500';
                statusIcon.innerHTML = '<svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                statusText.textContent = "متصل";
                userIdDisplay.style.color = 'rgb(34 197 94)'; // green
                
            } else {
                statusIcon.className = 'rounded-full h-24 w-24 mx-auto flex items-center justify-center mb-4 transition-all duration-500 bg-gray-400';
                statusIcon.innerHTML = '<svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 13.293a1 1 0 001.414 0L14 9.414V13a1 1 0 102 0V6a1 1 0 00-1-1H9a1 1 0 100 2h3.586L9.707 9.707a1 1 0 000 1.414l-1 1a1 1 0 000 1.414z" clip-rule="evenodd"></path></svg>';
                statusText.textContent = "غير متصل";
                userIdDisplay.style.color = 'rgb(156 163 175)'; // gray
            }
        }
        
        // Check for Firebase config and initialize the application
        function checkFirebaseConfigAndInitialize() {
            let firebaseConfig = null;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config.trim() !== '') {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.error("خطأ في تحليل إعدادات Firebase:", e);
            }
            
            if (!firebaseConfig || !firebaseConfig.projectId) {
                const errorMessage = "خطأ في التهيئة: لم يتم العثور على إعدادات Firebase. لا يمكن تهيئة التطبيق.";
                userIdDisplay.textContent = 'خطأ في التهيئة';
                showMessage(errorMessage, 'error');
                console.error(errorMessage, "Received config string was:", typeof __firebase_config !== 'undefined' ? __firebase_config : 'undefined');
                disableDatabaseButtons();
                updateStatus(false);
                return;
            }
            
            initializeFirebaseAndAuth(firebaseConfig);
        }

        // Initialize Firebase and handle authentication
        function initializeFirebaseAndAuth(firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Use onAuthStateChanged to ensure Firebase is ready before any operations
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `معرف المستخدم: ${userId}`;
                        recordsCollection = collection(db, `/artifacts/${appId}/users/${userId}/medical_records`);
                        loadRecords();
                        updateStatus(true);
                    } else {
                        // If not signed in, sign in anonymously or with custom token
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication Error:", error);
                            userIdDisplay.textContent = 'خطأ في المصادقة';
                            showMessage("خطأ في المصادقة: " + error.message, 'error');
                            updateStatus(false);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userIdDisplay.textContent = 'خطأ في التهيئة';
                showMessage("خطأ في تهيئة Firebase: " + error.message, 'error');
                disableDatabaseButtons();
                updateStatus(false);
            }
        }

        // Disable buttons related to Firebase operations when offline or not authenticated
        function disableDatabaseButtons() {
            saveButton.disabled = true;
            exportButton.disabled = true;
            importButton.disabled = true;
            document.querySelectorAll('.edit-btn, .print-btn, .delete-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        // Display a temporary message to the user
        function showMessage(msg, type = 'success') {
            messageBox.textContent = msg;
            messageBox.className = `p-3 my-4 text-center rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Load records from Firestore and listen for real-time updates
        function loadRecords() {
            if (!recordsCollection) {
                console.warn("Records collection is not initialized.");
                return;
            }
            loadingIndicator.style.display = 'flex';
            onSnapshot(recordsCollection, (snapshot) => {
                records = [];
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                filterAndRenderRecords();
                loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Error fetching records:", error);
                showMessage("خطأ في جلب البيانات: " + error.message, 'error');
                loadingIndicator.style.display = 'none';
            });
        }

        // Filter and render records based on selected column and search input
        function filterAndRenderRecords() {
            const searchTerm = filterInput.value.toLowerCase();
            const selectedColumn = filterColumnSelect.value;
            
            const filteredRecords = records.filter(record => {
                const recordValue = record[selectedColumn] || '';
                return String(recordValue).toLowerCase().includes(searchTerm);
            });
            renderTable(filteredRecords);
        }

        // Render the records in the table
        function renderTable(data) {
            recordsTableBody.innerHTML = '';
            if (data.length === 0) {
                recordsTableBody.innerHTML = '<tr><td colspan="20" class="p-4 text-center text-gray-500">لا توجد سجلات مطابقة للبحث.</td></tr>';
                return;
            }
            data.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                // Get the timestamp and format it to a Gregorian date string
                const entryDate = record.timestamp ? new Date(record.timestamp).toLocaleDateString('en-US') : '';

                // Check for existence of local attachments for this record
                const hasLocalAttachments = localAttachments[record.id] && Object.keys(localAttachments[record.id]).length > 0;
                
                row.innerHTML = `
                    <td class="p-3 text-center">${record.approvalNumber || ''}</td>
                    <td class="p-3 text-center">${record.formNumber || ''}</td>
                    <td class="p-3 text-center">${record.patientName || ''}</td>
                    <td class="p-3 text-center">${record.doctorName || ''}</td>
                    <td class="p-3 text-center">${record.specialization || ''}</td>
                    <td class="p-3 text-center">${record.treatmentDate || ''}</td>
                    <td class="p-3 text-center">${record.hospital || ''}</td>
                    <td class="p-3 text-center">${record.hospitalTreatmentDate || ''}</td>
                    <td class="p-3 text-center">${record.laboratory || ''}</td>
                    <td class="p-3 text-center">${record.labTreatmentDate || ''}</td>
                    <td class="p-3 text-center">${record.pharmacy || ''}</td>
                    <td class="p-3 text-center">${record.pharmacyTreatmentDate || ''}</td>
                    <td class="p-3 text-center">${record.radiology || ''}</td>
                    <td class="p-3 text-center">${record.radiologyTreatmentDate || ''}</td>
                    <td class="p-3 text-center">${record.formFee || ''}</td>
                    <td class="p-3 text-center">${record.formDate || ''}</td>
                    <td class="p-3 text-center">${record.balanceDate || ''}</td>
                    <td class="p-3 text-center whitespace-nowrap">${entryDate}</td>
                    <td class="p-3 text-center whitespace-nowrap">
                        ${hasLocalAttachments ? '<span class="text-green-500">يوجد مرفقات محلية</span>' : '<span class="text-gray-400">لا يوجد مرفقات</span>'}
                    </td>
                    <td class="p-3 text-center whitespace-nowrap">
                        <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300" data-id="${record.id}">
                            تعديل
                        </button>
                        <button class="print-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ml-2" data-id="${record.id}">
                            طباعة
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ml-2" data-id="${record.id}">
                            حذف
                        </button>
                    </td>
                `;
                recordsTableBody.appendChild(row);
            });
            // Add event listeners to buttons after rendering
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', editRecord));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', deleteRecord));
            document.querySelectorAll('.print-btn').forEach(btn => btn.addEventListener('click', printRecord));
        }
        
        // Utility function to convert file to Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Save a new record or update an existing one
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                showMessage("لا يمكن الحفظ، لم يتم الاتصال بقاعدة البيانات.", 'error');
                return;
            }

            const formData = new FormData(form);
            const record = {
                approvalNumber: formData.get('approvalNumber'),
                formNumber: formData.get('formNumber'),
                patientName: formData.get('patientName'),
                doctorName: formData.get('doctorName'),
                specialization: formData.get('specialization'),
                treatmentDate: formData.get('treatmentDate'),
                hospital: formData.get('hospital'),
                hospitalTreatmentDate: formData.get('hospitalTreatmentDate'),
                formDate: formData.get('formDate'),
                balanceDate: formData.get('balanceDate'),
                laboratory: formData.get('laboratory'),
                labTreatmentDate: formData.get('labTreatmentDate'),
                pharmacy: formData.get('pharmacy'),
                pharmacyTreatmentDate: formData.get('pharmacyTreatmentDate'),
                radiology: formData.get('radiology'),
                radiologyTreatmentDate: formData.get('radiologyTreatmentDate'),
                formFee: formData.get('formFee'),
                timestamp: Date.now()
            };

            const files = {};
            const fileInputs = [
                { id: 'doctorFile', key: 'doctorFile' },
                { id: 'hospitalFile', key: 'hospitalFile' },
                { id: 'laboratoryFile', key: 'laboratoryFile' },
                { id: 'pharmacyFile', key: 'pharmacyFile' },
                { id: 'radiologyFile', key: 'radiologyFile' }
            ];

            // Handle file uploads
            for (const input of fileInputs) {
                const file = e.target[input.id].files[0];
                if (file) {
                    files[input.key] = {
                        name: file.name,
                        type: file.type,
                        data: await fileToBase64(file)
                    };
                }
            }

            try {
                let docRef;
                if (editingId) {
                    docRef = doc(db, `artifacts/${appId}/users/${userId}/medical_records`, editingId);
                    await setDoc(docRef, record);
                    if (Object.keys(files).length > 0) {
                        localAttachments[editingId] = files;
                    }
                    showMessage("تم تحديث السجل بنجاح!");
                    editingId = null;
                    saveButton.textContent = "حفظ السجل";
                } else {
                    docRef = await addDoc(recordsCollection, record);
                    if (Object.keys(files).length > 0) {
                        localAttachments[docRef.id] = files;
                    }
                    showMessage("تم حفظ السجل بنجاح!");
                }
                clearForm();
                filterAndRenderRecords(); // Re-render to show new local files
            } catch (error) {
                console.error("Error saving record:", error);
                showMessage("خطأ في حفظ السجل: " + error.message, 'error');
            }
        });

        // Edit a record
        function editRecord(e) {
            const id = e.target.dataset.id;
            const record = records.find(r => r.id === id);
            if (record) {
                editingId = id;
                document.getElementById('approvalNumber').value = record.approvalNumber || '';
                document.getElementById('formNumber').value = record.formNumber || '';
                document.getElementById('patientName').value = record.patientName || '';
                document.getElementById('doctorName').value = record.doctorName || '';
                document.getElementById('specialization').value = record.specialization || '';
                document.getElementById('treatmentDate').value = record.treatmentDate || '';
                document.getElementById('hospital').value = record.hospital || '';
                document.getElementById('hospitalTreatmentDate').value = record.hospitalTreatmentDate || '';
                document.getElementById('formDate').value = record.formDate || '';
                document.getElementById('balanceDate').value = record.balanceDate || '';
                document.getElementById('laboratory').value = record.laboratory || '';
                document.getElementById('labTreatmentDate').value = record.labTreatmentDate || '';
                document.getElementById('pharmacy').value = record.pharmacy || '';
                document.getElementById('pharmacyTreatmentDate').value = record.pharmacyTreatmentDate || '';
                document.getElementById('radiology').value = record.radiology || '';
                document.getElementById('radiologyTreatmentDate').value = record.radiologyTreatmentDate || '';
                document.getElementById('formFee').value = record.formFee || '';
                saveButton.textContent = "تحديث السجل";
                showMessage("يمكنك الآن تعديل السجل.", 'info');
                window.scrollTo(0, 0);
            }
        }
        
        // Print a record
        function printRecord(e) {
            const id = e.target.dataset.id;
            const record = records.find(r => r.id === id);
            if (!record) {
                showMessage("السجل غير موجود.", 'error');
                return;
            }
            
            const entryDate = record.timestamp ? new Date(record.timestamp).toLocaleDateString('en-US') : '';

            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة سجل</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; line-height: 1.6; color: #333; }
                        h1 { text-align: center; color: #1e40af; margin-bottom: 20px; }
                        .record-container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #f9fafb; max-width: 800px; margin: auto; }
                        .record-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
                        .record-item:last-child { border-bottom: none; }
                        .label { font-weight: bold; color: #4b5563; }
                        .value { text-align: left; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; color-adjust: exact; }
                            .record-container { border: none; box-shadow: none; background-color: white; }
                        }
                    </style>
                </head>
                <body>
                    <div class="record-container">
                        <h1>بيانات السجل الطبي</h1>
                        <div class="record-item"><span class="label">رقم الموافقة:</span><span class="value">${record.approvalNumber || ''}</span></div>
                        <div class="record-item"><span class="label">رقم النموذج:</span><span class="value">${record.formNumber || ''}</span></div>
                        <div class="record-item"><span class="label">اسم المريض:</span><span class="value">${record.patientName || ''}</span></div>
                        <div class="record-item"><span class="label">اسم الطبيب:</span><span class="value">${record.doctorName || ''}</span></div>
                        <div class="record-item"><span class="label">التخصص:</span><span class="value">${record.specialization || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ المعالجة:</span><span class="value">${record.treatmentDate || ''}</span></div>
                        <div class="record-item"><span class="label">المستشفى:</span><span class="value">${record.hospital || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ معالجة المستشفى:</span><span class="value">${record.hospitalTreatmentDate || ''}</span></div>
                        <div class="record-item"><span class="label">المختبر:</span><span class="value">${record.laboratory || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ معالجة المختبر:</span><span class="value">${record.labTreatmentDate || ''}</span></div>
                        <div class="record-item"><span class="label">الصيدلية:</span><span class="value">${record.pharmacy || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ معالجة الصيدلية:</span><span class="value">${record.pharmacyTreatmentDate || ''}</span></div>
                        <div class="record-item"><span class="label">الأشعة:</span><span class="value">${record.radiology || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ معالجة الأشعة:</span><span class="value">${record.radiologyTreatmentDate || ''}</span></div>
                        <div class="record-item"><span class="label">رسوم النموذج:</span><span class="value">${record.formFee || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ النموذج:</span><span class="value">${record.formDate || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ التأثير على الرصيد:</span><span class="value">${record.balanceDate || ''}</span></div>
                        <div class="record-item"><span class="label">تاريخ الإدخال (ميلادي):</span><span class="value">${entryDate}</span></div>
                    </div>
                </body>
                </html>
            `;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // Delete a record
        async function deleteRecord(e) {
             if (!db) {
                showMessage("لا يمكن الحذف، لم يتم الاتصال بقاعدة البيانات.", 'error');
                return;
            }

            const id = e.target.dataset.id;
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmBtn = document.getElementById('confirm-delete');
            const cancelBtn = document.getElementById('cancel-delete');
            
            confirmationModal.classList.remove('hidden');

            const handleConfirm = async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/medical_records`, id));
                    delete localAttachments[id]; // Also remove from local storage
                    showMessage("تم حذف السجل بنجاح.");
                } catch (error) {
                    console.error("Error deleting record:", error);
                    showMessage("خطأ في حذف السجل: " + error.message, 'error');
                } finally {
                    confirmationModal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                }
            };
            
            const handleCancel = () => {
                confirmationModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // Clear the form
        function clearForm() {
            form.reset();
            editingId = null;
            saveButton.textContent = "حفظ السجل";
            showMessage("تم مسح النموذج.", 'info');
        }
        clearButton.addEventListener('click', clearForm);
        
        // Event listeners for the new filter functionality
        filterInput.addEventListener('input', filterAndRenderRecords);
        filterColumnSelect.addEventListener('change', filterAndRenderRecords);

        // Export data to JSON file (database backup)
        async function exportDatabase() {
            if (!db || !recordsCollection) {
                showMessage("لا يمكن التصدير: لم يتم تهيئة قاعدة البيانات.", 'error');
                return;
            }
            try {
                const querySnapshot = await getDocs(recordsCollection);
                const allRecords = [];
                querySnapshot.forEach(doc => {
                    const record = { id: doc.id, ...doc.data() };
                    // Merge local attachments with the record data before export
                    if (localAttachments[record.id]) {
                        record.attachments = localAttachments[record.id];
                    }
                    allRecords.push(record);
                });

                const jsonContent = JSON.stringify(allRecords, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'medical_records_backup.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage("تم تصدير قاعدة البيانات بنجاح!", 'success');
            } catch (error) {
                console.error("Error exporting data:", error);
                showMessage("خطأ في تصدير البيانات: " + error.message, 'error');
            }
        }
        
        // Import data from a JSON file
        async function importDatabase(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!db || !recordsCollection) {
                showMessage("لا يمكن الاستيراد: لم يتم تهيئة قاعدة البيانات.", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!Array.isArray(importedData)) {
                        showMessage("الملف الذي تم تحميله ليس بتنسيق قاعدة بيانات صالح.", 'error');
                        return;
                    }

                    // Show confirmation modal
                    const importConfirmationModal = document.getElementById('import-confirmation-modal');
                    const confirmImportBtn = document.getElementById('confirm-import');
                    const cancelImportBtn = document.getElementById('cancel-import');
                    importConfirmationModal.classList.remove('hidden');

                    const handleConfirm = async () => {
                        try {
                            loadingIndicator.style.display = 'flex';
                            for (const record of importedData) {
                                // Extract attachments to local storage first
                                if (record.attachments) {
                                    localAttachments[record.id] = record.attachments;
                                    delete record.attachments; // Remove attachments from the Firestore record
                                }
                                // Save the main record to Firestore
                                await setDoc(doc(recordsCollection, record.id), record);
                            }
                            showMessage("تم استيراد البيانات بنجاح!", 'success');
                        } catch (error) {
                            console.error("Error importing data:", error);
                            showMessage("خطأ في استيراد البيانات: " + error.message, 'error');
                        } finally {
                            loadingIndicator.style.display = 'none';
                            importConfirmationModal.classList.add('hidden');
                            confirmImportBtn.removeEventListener('click', handleConfirm);
                            cancelImportBtn.removeEventListener('click', handleCancel);
                        }
                    };
                    
                    const handleCancel = () => {
                        importConfirmationModal.classList.add('hidden');
                        confirmImportBtn.removeEventListener('click', handleConfirm);
                        cancelImportBtn.removeEventListener('click', handleCancel);
                    };

                    confirmImportBtn.addEventListener('click', handleConfirm);
                    cancelImportBtn.addEventListener('click', handleCancel);

                } catch (error) {
                    showMessage("خطأ في تحليل ملف JSON. تأكد من أن الملف صالح.", 'error');
                }
            };
            reader.readAsText(file);
        }

        // Add event listeners to the export and import buttons
        exportButton.addEventListener('click', exportDatabase);
        importButton.addEventListener('click', () => {
            if (!db) {
                showMessage("لا يمكن الاستيراد في وضع عدم الاتصال.", 'error');
                return;
            }
            importFileInput.click();
        });
        importFileInput.addEventListener('change', importDatabase);

        // Wait for the window to load before initializing Firebase and auth
        window.onload = function() {
            checkFirebaseConfigAndInitialize();
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-4xl font-bold text-blue-800 mb-4 md:mb-0">نظام إدخال مطالبات التأمين الصحي</h1>
            <div class="text-center">
                <div id="status-icon" class="rounded-full h-24 w-24 mx-auto flex items-center justify-center mb-4 transition-all duration-500 bg-gray-400">
                     <!-- Icon will be inserted by JS -->
                </div>
                <p id="status-text" class="text-lg font-semibold text-gray-700">جارٍ التحقق...</p>
                <p id="user-id-display" class="text-sm font-mono mt-2 text-gray-500">جارٍ تهيئة المستخدم...</p>
            </div>
        </div>

        <div id="message-box" class="hidden"></div>

        <form id="record-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Data Fields -->
                <div>
                    <label for="approvalNumber" class="block text-sm font-medium text-gray-700">رقم الموافقة</label>
                    <input type="text" id="approvalNumber" name="approvalNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="formNumber" class="block text-sm font-medium text-gray-700">رقم النموذج</label>
                    <input type="text" id="formNumber" name="formNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                 <div>
                    <label for="patientName" class="block text-sm font-medium text-gray-700">اسم المريض</label>
                    <input type="text" id="patientName" name="patientName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="doctorName" class="block text-sm font-medium text-gray-700">اسم الطبيب</label>
                    <input type="text" id="doctorName" name="doctorName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                 <div>
                    <label for="specialization" class="block text-sm font-medium text-gray-700">التخصص</label>
                    <input type="text" id="specialization" name="specialization" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="treatmentDate" class="block text-sm font-medium text-gray-700">تاريخ المعالجة</label>
                    <input type="date" id="treatmentDate" name="treatmentDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="hospital" class="block text-sm font-medium text-gray-700">المستشفى</label>
                    <input type="text" id="hospital" name="hospital" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="hospitalTreatmentDate" class="block text-sm font-medium text-gray-700">تاريخ معالجة المستشفى</label>
                    <input type="date" id="hospitalTreatmentDate" name="hospitalTreatmentDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="laboratory" class="block text-sm font-medium text-gray-700">المختبر</label>
                    <input type="text" id="laboratory" name="laboratory" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="labTreatmentDate" class="block text-sm font-medium text-gray-700">تاريخ معالجة المختبر</label>
                    <input type="date" id="labTreatmentDate" name="labTreatmentDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="pharmacy" class="block text-sm font-medium text-gray-700">الصيدلية</label>
                    <input type="text" id="pharmacy" name="pharmacy" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="pharmacyTreatmentDate" class="block text-sm font-medium text-gray-700">تاريخ معالجة الصيدلية</label>
                    <input type="date" id="pharmacyTreatmentDate" name="pharmacyTreatmentDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="radiology" class="block text-sm font-medium text-gray-700">الأشعة</label>
                    <input type="text" id="radiology" name="radiology" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="radiologyTreatmentDate" class="block text-sm font-medium text-gray-700">تاريخ معالجة الأشعة</label>
                    <input type="date" id="radiologyTreatmentDate" name="radiologyTreatmentDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="formFee" class="block text-sm font-medium text-gray-700">رسوم النموذج</label>
                    <input type="number" step="0.01" id="formFee" name="formFee" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="formDate" class="block text-sm font-medium text-gray-700">تاريخ النموذج</label>
                    <input type="date" id="formDate" name="formDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="balanceDate" class="block text-sm font-medium text-gray-700">تاريخ التأثير على الرصيد</label>
                    <input type="date" id="balanceDate" name="balanceDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <!-- File Attachments Section -->
            <div class="pt-6 border-t">
                 <h3 class="text-lg font-medium text-gray-900 mb-4">المرفقات</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="doctorFile" class="block text-sm font-medium text-gray-700">مرفق الطبيب</label>
                        <input type="file" id="doctorFile" name="doctorFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                     <div>
                        <label for="hospitalFile" class="block text-sm font-medium text-gray-700">مرفق المستشفى</label>
                        <input type="file" id="hospitalFile" name="hospitalFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div>
                        <label for="laboratoryFile" class="block text-sm font-medium text-gray-700">مرفق المختبر</label>
                        <input type="file" id="laboratoryFile" name="laboratoryFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                     <div>
                        <label for="pharmacyFile" class="block text-sm font-medium text-gray-700">مرفق الصيدلية</label>
                        <input type="file" id="pharmacyFile" name="pharmacyFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div>
                        <label for="radiologyFile" class="block text-sm font-medium text-gray-700">مرفق الأشعة</label>
                        <input type="file" id="radiologyFile" name="radiologyFile" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                 </div>
            </div>

            <div class="flex items-center justify-end space-x-4 pt-5">
                <button type="button" id="clear-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300">مسح النموذج</button>
                <button type="submit" id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">حفظ السجل</button>
            </div>
        </form>

        <div class="mt-10 pt-6 border-t">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                 <h2 class="text-2xl font-bold text-gray-800">قائمة السجلات</h2>
                 <div class="flex items-center gap-4 w-full md:w-auto">
                    <select id="filter-column-select" class="block w-full md:w-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                         <option value="approvalNumber">رقم الموافقة</option>
                         <option value="formNumber">رقم النموذج</option>
                         <option value="patientName">اسم المريض</option>
                         <option value="doctorName">اسم الطبيب</option>
                         <option value="hospital">المستشفى</option>
                    </select>
                    <input type="text" id="filter-input" placeholder="ابحث هنا..." class="block w-full md:w-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                 </div>
                 <div class="flex items-center gap-2">
                     <button id="export-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">تصدير</button>
                     <button id="import-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">استيراد</button>
                     <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>
            <div class="overflow-x-auto bg-white rounded-lg shadow">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Table Headers -->
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">رقم الموافقة</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">رقم النموذج</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">اسم المريض</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">اسم الطبيب</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">التخصص</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ المعالجة</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">المستشفى</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ المستشفى</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">المختبر</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ المختبر</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">الصيدلية</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ الصيدلية</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">الأشعة</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ الأشعة</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">رسوم النموذج</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ النموذج</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ الرصيد</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">تاريخ الإدخال</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">المرفقات</th>
                            <th class="p-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">تأكيد الحذف</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">هل أنت متأكد من أنك تريد حذف هذا السجل؟ لا يمكن التراجع عن هذا الإجراء.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">نعم، احذف</button>
                    <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Import -->
    <div id="import-confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">تأكيد الاستيراد</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">سيؤدي هذا إلى الكتابة فوق أي سجلات موجودة بنفس المعرفات. هل تريد المتابعة؟</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-import" class="px-4 py-2 bg-purple-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">نعم، استورد</button>
                    <button id="cancel-import" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">إلغاء</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full items-center justify-center">
        <div class="flex flex-col items-center">
             <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
             <p class="text-white mt-4 text-lg">جارٍ التحميل...</p>
        </div>
    </div>

</body>
</html>

