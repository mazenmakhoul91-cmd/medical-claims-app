<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدخال مطالبات التأمين الصحي - Google Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container-main {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-6">
    <div class="container-main max-w-7xl mx-auto p-8 rounded-xl shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">نظام إدخال مطالبات التأمين الصحي</h1>
            <p class="text-gray-600">التخزين عبر Google Sheets والمرفقات عبر Google Drive</p>
            <div id="auth-status" class="mt-4">
                <button id="authorize-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300" disabled>
                    جاري تحميل تسجيل الدخول...
                </button>
                <button id="signout-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">
                    تسجيل الخروج
                </button>
            </div>
            <div id="user-info" class="hidden mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 rounded-lg text-center mb-4" role="alert"></div>

        <!-- Main Content (Hidden until authenticated) -->
        <div id="main-content" class="hidden">
            <!-- النموذج وواجهة التطبيق كما في الكود السابق (لم يتم تغيير النظام) -->
            <!-- يمكنك نسخ النموذج من الكود الأصلي إذا كان هناك تعديلات إضافية -->
        </div>
    </div>
    <!-- باقي الصفحة والسكريبتات ... -->

    <script>
        // إعدادات Google API
        const CLIENT_ID = '696330237242-saogi2mnnmubpi6fffe6j69v3k7dgh55.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyC8mQ9v1MfAqPXzqeV850ETHrrFqiaExqs';
        const SPREADSHEET_ID = '1gokXoCPd9XtH7eq92MGJF-d5hEmDgjGEJV5Gk4_9hJk';
        const DRIVE_FOLDER_ID = '1FMl04vxqLZ02DyB8cy4YItDw_vV9tY_7';
        const DISCOVERY_DOCS = [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

        let authorizeButton = document.getElementById('authorize-button');
        let signoutButton = document.getElementById('signout-button');
        let mainContent = document.getElementById('main-content');
        let userInfo = document.getElementById('user-info');
        let editingRow = null;
        let allRecords = [];

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function() {
                // تفعيل زر تسجيل الدخول بعد تحميل وتهيئة Google API
                authorizeButton.disabled = false;
                authorizeButton.innerText = "تسجيل الدخول بحساب Google";
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }, function(error) {
                console.error('Error initializing Google API client:', error);
                showMessage('خطأ في تهيئة Google API. تحقق من الإعدادات.', 'error');
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                userInfo.innerHTML = `مرحباً، ${profile.getName()} (${profile.getEmail()})`;
                userInfo.classList.remove('hidden');
                checkAndCreateSpreadsheet();
                loadRecords();
            } else {
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                mainContent.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
        }

        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        async function checkAndCreateSpreadsheet() {
            try {
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID
                });
                const range = 'Sheet1!A1:T1';
                const valuesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range
                });
                if (!valuesResponse.result.values || valuesResponse.result.values[0].length === 0) {
                    const headers = [
                        'رقم الموافقة', 'رقم النموذج', 'اسم المريض', 'اسم الطبيب', 'التخصص',
                        'تاريخ المعالجة', 'المستشفى', 'تاريخ معالجة المستشفى', 'المختبر', 'تاريخ معالجة المختبر',
                        'الصيدلية', 'تاريخ معالجة الصيدلية', 'الأشعة', 'تاريخ معالجة الأشعة',
                        'رسوم النموذج', 'تاريخ النموذج', 'تاريخ التأثير على الرصيد', 'تاريخ الإدخال',
                        'روابط المرفقات', 'معرف السجل'
                    ];
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Sheet1!A1:T1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [headers]
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking spreadsheet:', error);
                showMessage('تحذير: تحقق من صحة معرف جدول البيانات', 'error');
            }
        }

        async function loadRecords() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A2:T'
                });
                allRecords = response.result.values || [];
                if (typeof filterAndDisplayRecords === "function") {
                    filterAndDisplayRecords();
                }
            } catch (error) {
                console.error('Error loading records:', error);
                showMessage('خطأ في تحميل البيانات', 'error');
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
        }

        window.onload = handleClientLoad;
    </script>
</body>
</html>